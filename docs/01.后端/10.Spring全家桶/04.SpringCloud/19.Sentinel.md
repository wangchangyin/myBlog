# Sentinel

[官网](https://github.com/alibaba/Sentinel/wiki/%E4%BB%8B%E7%BB%8D)

[使用手册](https://spring-cloud-alibaba-group.github.io/github-pages/greenwich/spring-cloud-alibaba.html#_spring_cloud_alibaba_sentinel)

## 1.hystrix和sentinel

![image-20210831104015667](https://gitee.com/wcy_dch/images/raw/master/img/image-20210831104015667.png)

## 2.sentinel的特性

- **丰富的应用场景**：Sentinel 承接了阿里巴巴近 10 年的双十一大促流量的核心场景，例如秒杀（即突发流量控制在系统容量可以承受的范围）、消息削峰填谷、集群流量控制、实时熔断下游不可用应用等。
- **完备的实时监控**：Sentinel 同时提供实时的监控功能。您可以在控制台中看到接入应用的单台机器秒级数据，甚至 500 台以下规模的集群的汇总运行情况。
- **广泛的开源生态**：Sentinel 提供开箱即用的与其它开源框架/库的整合模块，例如与 Spring Cloud、Apache Dubbo、gRPC、Quarkus 的整合。您只需要引入相应的依赖并进行简单的配置即可快速地接入 Sentinel。同时 Sentinel 提供 Java/Go/C++ 等多语言的原生实现。
- **完善的 SPI 扩展机制**：Sentinel 提供简单易用、完善的 SPI 扩展接口。您可以通过实现扩展接口来快速地定制逻辑。例如定制规则管理、适配动态数据源等。

## 3.sentinel下载

[下载地址](https://github.com/alibaba/Sentinel/releases)

版本：1.7.0

运行：

```
java -jar sentinel-dashboard-1.7.0.jar
```

访问：

```
http://localhost:8080/
```

登录账号密码均为sentinel

## 4.sentinel能干嘛

- 服务雪崩
- 服务降级
- 服务熔断
- 服务限流

## 5.微服务注册进sentinel

### 1.新建模块：cloudalibaba-sentinel-service8401

### 2.导入依赖

- spring-cloud-starter-alibaba-nacos-discovery：nacos注册
- spring-cloud-starter-alibaba-sentinel：sentinel服务
- sentinel-datasource-nacos：持久化

```
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>CloudStudy</artifactId>
        <groupId>com.wcy.springcloud</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>cloudalibaba-sentinel-service8401</artifactId>

    <dependencies>
        <!--SpringCloud ailibaba nacos -->
        <dependency>
            <groupId>com.alibaba.cloud</groupId>
            <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
        </dependency>
        <!--SpringCloud ailibaba sentinel-datasource-nacos 后续做持久化用到-->
        <dependency>
            <groupId>com.alibaba.csp</groupId>
            <artifactId>sentinel-datasource-nacos</artifactId>
        </dependency>
        <!--SpringCloud ailibaba sentinel -->
        <dependency>
            <groupId>com.alibaba.cloud</groupId>
            <artifactId>spring-cloud-starter-alibaba-sentinel</artifactId>
        </dependency>
        <!--openfeign-->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-openfeign</artifactId>
        </dependency>
        <!-- SpringBoot整合Web组件+actuator -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-actuator</artifactId>
        </dependency>
        <!--日常通用jar包配置-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-devtools</artifactId>
            <scope>runtime</scope>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>cn.hutool</groupId>
            <artifactId>hutool-all</artifactId>
            <version>4.6.3</version>
        </dependency>
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>

    </dependencies>

</project>
```

### 3.修改配置文件

```
server:
  port: 8401

spring:
  application:
    name: cloudalibaba-sentinel-service
  cloud:
    nacos:
      discovery:
        #Nacos服务注册中心地址
        server-addr: localhost:8848
    sentinel:
      transport:
        #配置Sentinel dashboard地址
        dashboard: localhost:8080
        #默认8719端口，假如被占用会自动从8719开始依次+1扫描,直至找到未被占用的端口
        port: 8719

management:
  endpoints:
    web:
      exposure:
        include: '*'
```

### 4.主启动类

```
package com.wcy.springcloud;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;

@EnableDiscoveryClient
@SpringBootApplication
public class MainApp8401
{
    public static void main(String[] args) {
        SpringApplication.run(MainApp8401.class, args);
    }
}

```

### 5.业务类

```
package com.wcy.springcloud.controller;

import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class FlowLimitController
{

    @GetMapping("/testA")
    public String testA()
    {
        return "------testA";
    }

    @GetMapping("/testB")
    public String testB()
    {
        return "------testB";
    }
}
```

*******************************************************************

### 6.环境准备

- 启动nacos8848
- 启动sentinel8080
- 启动微服务8401

### 7.测试

访问：http://localhost:8080/，发现并没有监控8401，是因为sentinel默认使用懒加载策略，只有8401访问了的url才会被注册进去。

> 访问http://localhost:8401/testA和http://localhost:8401/testB

可以看到8401已经被sentinel监控

## 6.Sentinel流控规则

可对某url进行流量控制

![image-20210901095055098](https://gitee.com/wcy_dch/images/raw/master/img/image-20210901095055098.png)

### 1.流控模式-QPS直接

对/testA该URL进行流量控制，一秒超过一次请求则直接抛出错误

![image-20210901095214083](https://gitee.com/wcy_dch/images/raw/master/img/image-20210901095214083.png)

再次访问http://localhost:8401/testA，一秒进行一次请求是正常的，多点几次就会直接报错：

> Blocked by Sentinel (flow limiting)

### 2.流控模式-线程数

- QPS：每秒多少次请求
- 线程数：该URL不能超过多少个线程数

休眠一秒，模拟线程数，修改阈值为线程数，再访问http://localhost:8401/testA，不听的F5可以看到效果。

```
    @GetMapping("/testA")
    public String testA() throws InterruptedException {
        TimeUnit.SECONDS.sleep(1L);//休眠一秒
        return "------testA"+ UUID.randomUUID().toString();
    }
```





















