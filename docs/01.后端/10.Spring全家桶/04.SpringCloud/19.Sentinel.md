# Sentinel

[官网](https://github.com/alibaba/Sentinel/wiki/%E4%BB%8B%E7%BB%8D)

[使用手册](https://spring-cloud-alibaba-group.github.io/github-pages/greenwich/spring-cloud-alibaba.html#_spring_cloud_alibaba_sentinel)

## 1.hystrix和sentinel

![image-20210831104015667](https://gitee.com/wcy_dch/images/raw/master/img/image-20210831104015667.png)

## 2.sentinel的特性

- **丰富的应用场景**：Sentinel 承接了阿里巴巴近 10 年的双十一大促流量的核心场景，例如秒杀（即突发流量控制在系统容量可以承受的范围）、消息削峰填谷、集群流量控制、实时熔断下游不可用应用等。
- **完备的实时监控**：Sentinel 同时提供实时的监控功能。您可以在控制台中看到接入应用的单台机器秒级数据，甚至 500 台以下规模的集群的汇总运行情况。
- **广泛的开源生态**：Sentinel 提供开箱即用的与其它开源框架/库的整合模块，例如与 Spring Cloud、Apache Dubbo、gRPC、Quarkus 的整合。您只需要引入相应的依赖并进行简单的配置即可快速地接入 Sentinel。同时 Sentinel 提供 Java/Go/C++ 等多语言的原生实现。
- **完善的 SPI 扩展机制**：Sentinel 提供简单易用、完善的 SPI 扩展接口。您可以通过实现扩展接口来快速地定制逻辑。例如定制规则管理、适配动态数据源等。

## 3.sentinel下载

[下载地址](https://github.com/alibaba/Sentinel/releases)

版本：1.7.0

运行：

```
java -jar sentinel-dashboard-1.7.0.jar

//linux后台启动
nohup java -jar sentinel-dashboard-1.7.2.jar --server.port=8718 &
```

访问：

```
http://localhost:8080/
```

登录账号密码均为sentinel

## 4.sentinel能干嘛

- 服务雪崩
- 服务降级
- 服务熔断
- 服务限流

## 5.微服务注册进sentinel

### 1.新建模块：cloudalibaba-sentinel-service8401

### 2.导入依赖

- spring-cloud-starter-alibaba-nacos-discovery：nacos注册
- spring-cloud-starter-alibaba-sentinel：sentinel服务
- sentinel-datasource-nacos：持久化

```
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>CloudStudy</artifactId>
        <groupId>com.wcy.springcloud</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>cloudalibaba-sentinel-service8401</artifactId>

    <dependencies>
        <!--SpringCloud ailibaba nacos -->
        <dependency>
            <groupId>com.alibaba.cloud</groupId>
            <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
        </dependency>
        <!--SpringCloud ailibaba sentinel-datasource-nacos 后续做持久化用到-->
        <dependency>
            <groupId>com.alibaba.csp</groupId>
            <artifactId>sentinel-datasource-nacos</artifactId>
        </dependency>
        <!--SpringCloud ailibaba sentinel -->
        <dependency>
            <groupId>com.alibaba.cloud</groupId>
            <artifactId>spring-cloud-starter-alibaba-sentinel</artifactId>
        </dependency>
        <!--openfeign-->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-openfeign</artifactId>
        </dependency>
        <!-- SpringBoot整合Web组件+actuator -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-actuator</artifactId>
        </dependency>
        <!--日常通用jar包配置-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-devtools</artifactId>
            <scope>runtime</scope>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>cn.hutool</groupId>
            <artifactId>hutool-all</artifactId>
            <version>4.6.3</version>
        </dependency>
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>

    </dependencies>

</project>
```

### 3.修改配置文件

```
server:
  port: 8401

spring:
  application:
    name: cloudalibaba-sentinel-service
  cloud:
    nacos:
      discovery:
        #Nacos服务注册中心地址
        server-addr: localhost:8848
    sentinel:
      transport:
        #配置Sentinel dashboard地址
        dashboard: localhost:8080
        #默认8719端口，假如被占用会自动从8719开始依次+1扫描,直至找到未被占用的端口
        port: 8719

management:
  endpoints:
    web:
      exposure:
        include: '*'
```

### 4.主启动类

```
package com.wcy.springcloud;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;

@EnableDiscoveryClient
@SpringBootApplication
public class MainApp8401
{
    public static void main(String[] args) {
        SpringApplication.run(MainApp8401.class, args);
    }
}

```

### 5.业务类

```
package com.wcy.springcloud.controller;

import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class FlowLimitController
{

    @GetMapping("/testA")
    public String testA()
    {
        return "------testA";
    }

    @GetMapping("/testB")
    public String testB()
    {
        return "------testB";
    }
}
```

*******************************************************************

### 6.环境准备

- 启动nacos8848
- 启动sentinel8080
- 启动微服务8401

### 7.测试

访问：http://localhost:8080/，发现并没有监控8401，是因为sentinel默认使用懒加载策略，只有8401访问了的url才会被注册进去。

> 访问http://localhost:8401/testA和http://localhost:8401/testB

可以看到8401已经被sentinel监控

## 6.Sentinel流控规则

可对某url进行流量控制

![image-20210901095055098](https://gitee.com/wcy_dch/images/raw/master/img/image-20210901095055098.png)

### 1.流控模式-QPS直接

对/testA该URL进行流量控制，一秒超过一次请求则直接抛出错误

![image-20210901095214083](https://gitee.com/wcy_dch/images/raw/master/img/image-20210901095214083.png)

再次访问http://localhost:8401/testA，一秒进行一次请求是正常的，多点几次就会直接报错：

> Blocked by Sentinel (flow limiting)

直接->快速失败(默认的流控处理)的源码：com.alibaba.csp.sentinel.slots.block.flow.controller.DefaultController

### 2.流控模式-线程数

- QPS：每秒多少次请求
- 线程数：该URL不能超过多少个线程数

休眠一秒，模拟线程数，修改阈值为线程数，再访问http://localhost:8401/testA，不听的F5可以看到效果。

```
    @GetMapping("/testA")
    public String testA() throws InterruptedException {
        TimeUnit.SECONDS.sleep(1L);//休眠一秒
        return "------testA"+ UUID.randomUUID().toString();
    }
```

### 3.流控模式-关联

> 当配置/testA的url关联/testB的url，如果/testB该url访问流量过大，对应的/testA也会限流
>
> 别人惹事，自己限流

![image-20210902141413245](https://gitee.com/wcy_dch/images/raw/master/img/image-20210902141413245.png)

### 4.流控模式-链路

如果testA和testB都访问调用/testC,可以限制对testC设置限流，入门为testA，那么testA的QPS超过阈值则不允许访问。

### 5.预热模式Warm Up

开始流量很少，但是后续突增流量，若不加以控制，服务可能宕机，所以给某个请求设置预热模式，比如设置阈值为10，则开始的时候只能请求3QPS，后续慢慢的增加到10；

> 如：秒杀系统在开启的瞬间，会有很多流量上来，很有可能把系统打死，预热方式就是把为了保护系统，可慢慢的把流量放进来，慢慢的把阀值增长到设置的阀值。

对/testB设置预热模式，阈值为10，访问/testB开始的时候只有10/3的QPS，五秒后慢慢的加到10的QPS

![image-20210902144020631](https://gitee.com/wcy_dch/images/raw/master/img/image-20210902144020631.png)

说明：

> 公式：阈值除以coldFactor(默认值为3),经过预热时长后才会达到阈值
>
> 默认coldFactor为3，即请求 QPS 从 threshold / 3 开始，经预热时长逐渐升至设定的 QPS 阈值。
>
> 官网：https://github.com/alibaba/Sentinel/wiki/%E9%99%90%E6%B5%81---%E5%86%B7%E5%90%AF%E5%8A%A8
>
> 源码：com.alibaba.csp.sentinel.slots.block.flow.controller.WarmUpController

### 6.排队等待

请求服务不被直接拒绝，而是排队等待

> 匀速排队，阈值必须设置为QPS
>
> 官网：https://github.com/alibaba/Sentinel/wiki/%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6
>
> 源码：com.alibaba.csp.sentinel.slots.block.flow.controller.RateLimiterController

![image-20210902144931222](https://gitee.com/wcy_dch/images/raw/master/img/image-20210902144931222.png)



设置每秒10的QPS，超过10后等待2秒

![image-20210902150305548](https://gitee.com/wcy_dch/images/raw/master/img/image-20210902150305548.png)

使用postman模拟并发测试：

![image-20210902150425084](https://gitee.com/wcy_dch/images/raw/master/img/image-20210902150425084.png)

查看idea控制台，一秒只有10个请求

![image-20210902150450667](https://gitee.com/wcy_dch/images/raw/master/img/image-20210902150450667.png)

## 7.降级规则

[官网](https://github.com/alibaba/Sentinel/wiki/%E7%86%94%E6%96%AD%E9%99%8D%E7%BA%A7)

### 1.RT平均响应时间

> 平均响应时间(DEGRADE_GRADE_RT ):当1s内持续进入5个请求，对应时刻的平均响应时间(秒级）均超过阈值（ count，以 ms为单位)，那么在接下的时间窗口( DegradeRule中的timewindow，以s为单位)之内，对这个方法的调用都会自动地熔断(抛出DegradeException )。
>
> 注意Sentinel 默认统计的RT上限是4900 ms，超出此阈值的都会算作4900 ms，若需要变更此上限可以通过启动配置项-Dcsp.sentinel.statistic.max.rt=xxx来配置。

![image-20210903162713068](https://gitee.com/wcy_dch/images/raw/master/img/image-20210903162713068.png)

#### 1.controller中testA服务休眠一秒

```
    @GetMapping("/testA")
    public String testA() throws InterruptedException {
        TimeUnit.SECONDS.sleep(1L);//休眠一秒
        return "------testA"+ UUID.randomUUID().toString();
    }
```

#### 2.对testA服务设置降级规则

1秒内超过五次请求切平均响应时间>500毫秒在2秒内触发降级

![image-20210903162907052](https://gitee.com/wcy_dch/images/raw/master/img/image-20210903162907052.png)

#### 3.不停的F5访问http://localhost:8401/testA

可以看到触发了降级，不允许访问，把RT设置为2000，就不会触发降级了。

### 2.异常比列

> 异常比例( DEGRADE_GRADE_EXCEPTION_RATIo ):当资源的每秒请求量>=5，并且每秒异常总数占通过量的比值超过阈值（ DegradeRule中的count ）之后，资源进入降级状态，即在接下的时间窗口( DegradeRule中的timeWindow，以s为单位)之内，对这个方法的调用都会自动地返回。异常比率的阈值范围是[0.0，1.0]，代表0% - 100%。

#### 1.controller层模拟异常请求

```
    @GetMapping("/testA")
    public String testA() throws InterruptedException {
        int a=10/0;
        return "------testA"+ UUID.randomUUID().toString();
    }
```

#### 2.sentinel设置降级规则

![image-20210903170558542](https://gitee.com/wcy_dch/images/raw/master/img/image-20210903170558542.png)

#### 3.访问http://localhost:8401/testA

注意：http://localhost:8401/testA由于该请求百分之百会报错误，如果一秒内没有超过五次请求，那么就不会被sentinel降级，会直接弹出runtimeException的页面错误；若不停的F5，则可以看到sentinel对其进行了降级。

![image-20210903170745866](https://gitee.com/wcy_dch/images/raw/master/img/image-20210903170745866.png)

### 3.异常数

> 异常数( DEGRADE_GRADE_EXCEPTION_COUNT ):当资源近1分钟的异常数目超过阈值之后会进行熔断。注意由于统计时间窗口是分钟级别的，若 timewindow小于60s，则结束熔断状态后仍可能再进入熔断状态。

#### 1.controller层模拟异常请求

```
    @GetMapping("/testA")
    public String testA() throws InterruptedException {
        int a=10/0;
        return "------testA"+ UUID.randomUUID().toString();
    }
```

#### 2.sentinel设置降级规则

![image-20210903171420755](https://gitee.com/wcy_dch/images/raw/master/img/image-20210903171420755.png)

#### 3.访问http://localhost:8401/testA

当70秒内异常数超过五次则触发降级规则





